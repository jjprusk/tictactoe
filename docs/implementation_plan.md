# Implementation Plan

Concise, incremental steps to implement the TicTacToe AI system defined in `docs/request.md`. Steps are grouped by milestone; each step is intentionally small and builds on prior work.

## Guiding Principles
- Many small, verifiable steps; ship value early and often
- Backend-only AI; client is UI + real-time sync
- Tests first for core logic; maintain ≥90% coverage
- Observability, security, and reliability baked-in from the start
- Comprehensive end-to-end testing: introduce smoke E2E early, then expand to cover realtime flows, gameplay, and error paths as features land; run E2E in CI with clear, deterministic setup/teardown.
- Enforce minimum test coverage targets: lines/statements ≥70%, functions ≥70%, branches ≥60%
- Allow a fully working gameplay model to be implemented and validated prior to AI implementation. Maintain both a Random strategy and an AI strategy with a runtime toggle to switch between them for debugging and evaluation.
 - UI: Mobile-first design
 - UI: Easy to use (low cognitive load; clear affordances)
 - UI: Self-explanatory (minimal instructions required)
 - UI: Beautiful and aesthetically pleasing design

## Alignment with `docs/project_rules.md`
- Implement unified logger/debugger early (M1) and expand capabilities soon after (M8)
- Introduce asynchronous services (Socket.IO) early (M1–M4) with heavy async testing
- Use very descriptive variable names and write clean, effective code
- Add comments only for complex/critical sections
- Place all code strictly in `client/` or `server/`; all docs in `docs/`
- Provide tests with every milestone; extra coverage for async/networking
- Update `docs/checklist.md` after each approved milestone
- When sharing code in reviews/PRs, include full files (no placeholders)

## Coding Standards (applies to all milestones)
- Descriptive identifiers; avoid abbreviations; prefer clarity over brevity
- Minimal comments; only where logic is non-obvious; explain the “why”
- Consistent formatting (ESLint/Prettier); TypeScript strict mode
- Avoid deep nesting; use guard clauses; meaningful error handling
- Add a file header to all newly created code files containing: "© 2025 Joe Pruskowski"

## Per‑Milestone Housekeeping
- Mark completed steps in this plan after tests pass and approval
- Add brief notes of key decisions to `docs/notes.md`
- Ensure new code lives under `client/` or `server/` only; docs under `docs/`
- Ensure appropriate tests (unit/integration/E2E) are added/updated

-## Flat Implementation Steps (Ordered)
- [x] S001: Create repository structure with `server/`, `client/`, and `docs/` directories
- [x] S002: Add root package.json (or monorepo tooling if chosen)
- [x] S003: Initialize Git repository
- [x] S004: Create `.gitignore` with standard exclusions
- [x] S005: Add `.editorconfig` for consistent formatting
- [x] S006: Add LICENSE file (e.g., MIT)
- [x] S007: Create `README.md` with overview and setup instructions
- [x] S008: Specify Node.js engines (>=20) in package.json
- [x] S009: Choose package manager (npm) and commit lockfile
- [x] S010: Document dependency pinning policy in `README.md`
- [x] S011: Create `docs/notes.md`
- [x] S012: Create `.env.example` listing required environment variables
- [x] S013: Install and configure environment validation (zod)
- [x] S014: Implement environment loader with schema validation
- [x] S015: Create CI workflow file `.github/workflows/ci.yml`
- [x] S016: Add lint and typecheck jobs to CI
- [x] S017: Push dummy commit to verify CI runs
- [x] S018: Add PR template `.github/pull_request_template.md`
- [x] S019: Add `CODEOWNERS` file
- [x] S020: Install and configure commitlint and husky (Conventional Commits)
- [x] S021: Configure branch protections and required status checks on `main`
- [x] S022: Install Socket.IO server library and attach to HTTP server
- [x] S023: Emit a health event on client connect; log connect/disconnect
- [x] S024: Install configuration validation (zod/envsafe) for server
- [x] S025: Define config schema for ports and database URIs
- [x] S026: Load and validate env in server startup; fail fast on invalid
- [x] S027: Install MongoDB driver and implement connection with retry
- [x] S028: Add MongoDB ping check to `/readyz`
- [x] S029: Write unit tests for MongoDB connection handling
- [x] S030: Create `server/package.json`
- [x] S031: Install Express and types in server
- [x] S032: Create `server/src/index.ts`
- [x] S033: Initialize Express app with JSON middleware
- [x] S034: Add basic GET `/` route returning a hello message
- [x] S035: Install and configure logger (pino or winston)
- [x] S036: Add request correlation IDs via middleware
- [x] S037: Output structured logs to console and file
- [x] S038: Add minimal security headers: strict CORS and Content Security Policy
- [x] S039: Implement GET `/healthz` returning `{ status: 'ok' }`
- [x] S040: Implement GET `/readyz` performing readiness checks
- [x] S041: Write unit tests for `/healthz` and `/readyz`
- [x] S042: Install Socket.IO server library and attach to HTTP server
- [x] S043: Emit a health event on client connect; log connect/disconnect
- [x] S044: Install configuration validation (zod/envsafe) for server
- [x] S045: Define config schema for ports and database URIs
- [x] S046: Load and validate env in server startup; fail fast on invalid
- [x] S047: Install MongoDB driver and implement connection with retry
- [x] S048: Add MongoDB ping check to `/readyz`
- [x] S049: Write unit tests for MongoDB connection handling
- [x] S050: Install Redis client (ioredis or redis)
- [x] S051: Implement Redis connection and ping check
- [x] S052: Write unit tests for Redis operations
- [x] S053: Instrument Prometheus metrics (HTTP durations, socket reconnects)
- [x] S054: Add move latency histogram metric on server
- [x] S055: Initialize OpenTelemetry tracing (basic spans on move lifecycle)r
- [x] S056: Create `scripts/start-server.sh` with port cleanup and start
- [x] S057: Add SIGTERM handler for graceful server shutdown
- [x] S058: Test server start/stop scripts locally
- [x] S059: Define `Board` type (3x3) and `Cell` for engine
- [x] S060: Define `Player` type ('X' | 'O') and helpers
- [x] S061: Implement `GameState` (board, currentPlayer, moves)
- [x] S062: Implement `getLegalMoves(board)`
- [x] S063: Implement `applyMove(board, move, player)` (immutable)
- [x] S064: Implement `nextPlayer(current)` turn alternation
- [x] S065: Implement `checkWin(board)` for rows/cols/diagonals
- [x] S066: Implement `checkDraw(board)`
- [x] S067: Implement `isTerminal(board)` and integrate win/draw checks
- [x] S068: Implement JSON-safe state serialization
- [x] S069: Define event types `MoveMade` and `GameOver`
- [x] S070: Write unit tests for legal/illegal moves and immutability
- [x] S071: Write unit tests for all win patterns and draws
- [x] S072: Add property-based tests for engine invariants
- [x] S073: Create client app with Vite (React + TypeScript) in `client/` (optimize for mobile-first dev loop)
- [x] S074: Configure `vite.config.ts` with aliases and base settings
- [x] S075: Install and configure Tailwind CSS (PostCSS + autoprefixer); set mobile-first breakpoints
- [x] S076: Establish design tokens (CSS variables) for colors, typography scale, spacing, radius, shadows; document in `docs/request.md`
- [x] S077: Remove template boilerplate from `App.tsx`
- [x] S078: Install Redux Toolkit and React Redux in client
- [x] S079: Create `store.ts` and root reducer
- [x] S080: Add `session` slice with initial state including `strategy`
- [x] S081: Wrap app with Redux Provider in `index.tsx`
- [x] S082: Introduce baseline theme provider (light/dark) with tokens wired to Tailwind; persist user choice
- [x] S082a: Add Playwright smoke E2E (build + preview): verify header renders, Tailwind styles apply, theme persistence, and /logs POST via dev proxy
- [x] S083: Install Socket.IO client library
- [x] S084: Create client socket service (connect/disconnect handlers)
- [x] S085: Add connection status indicator component
- [x] S086: Dispatch Redux actions on socket events (state, errors)
- [x] S086a: E2E realtime connect: verify connect/disconnect UI, status indicator, and auto‑reconnect behavior
- [x] S087: Implement responsive layout (header, game area, options panel) with mobile-first stacks; collapse insights on small screens
- [x] S088: Add tasteful motion/animation for page transitions and result banner (Framer Motion), respecting reduced-motion
- [x] S089: Create header with title/logo
- [x] S090: Add placeholders for game board and insights panel
- [x] S091: Add microcopy and inline hints so flows are self-explanatory (no manual required)
- [x] S092: Create `scripts/start-client.sh` with port cleanup and start
- [x] S093: Test client start script locally
- [x] S094: Define Socket.IO event contracts (`create_game`, `join_game`, `leave_game`, `make_move`, `game_state`, `error`)
- [x] S095: Implement server event handlers with type-safe payloads
- [ ] S096: Implement client emitters with type-safe payloads
- [ ] S097: Add schema validation for received events
- [ ] S098: Implement room creation with generated `roomId` and host role
- [ ] S099: Implement role assignment on join (player/observer)
- [ ] S100: Track room membership and roles on server
- [ ] S101: Generate client-side nonce per move
- [ ] S102: Deduplicate moves on server by nonce per game
- [ ] S103: Use Socket.IO acknowledgements with timeouts
- [ ] S104: Implement standardized error payloads
- [ ] S105: Configure client reconnect with exponential backoff
- [ ] S106: On reconnect, rejoin room using a session token
- [ ] S106a: E2E contracts/flows: create/join/leave with acks and timeouts; standardized error payloads; reconnect with session token
- [ ] S107: Implement optimistic UI for moves and reconcile with server
- [ ] S108: Build `Board.tsx` 3x3 grid component (mobile-first sizing; responsive grid; min 44px touch targets)
- [ ] S109: Add touch and click handlers for squares (debounced; large hit areas)
- [ ] S110: Ensure visible focus outlines and full keyboard navigation (tab/arrow keys, Enter/Space)
- [ ] S111: Add keyboard navigation with appropriate ARIA roles
- [ ] S112: Implement current player indicator component
- [ ] S113: Highlight last move via CSS
- [ ] S114: Implement result banner (win/draw/draw) with accessible semantics and clear microcopy
- [ ] S115: Add reset button that emits reset event
- [ ] S116: Make spectator view read-only and label spectators
- [ ] S117: Implement lobby page fetching active games
- [ ] S118: Implement join button emitting `join_game`
- [ ] S119: Define `AIRequest` (gameState, player) and `AIResponse` (position) for future AI
- [ ] S120: Implement random-move strategy `pickRandomMove(board, player, rng?)`
- [ ] S121: Introduce `Strategy = 'random' | 'ai'` and `makeMove(board, player, strategy)` orchestrator (tracing + metrics)
- [ ] S122: Integrate random strategy into match flow (human vs random end-to-end)
- [ ] S123: Measure and log decision latency per strategy (Prometheus histogram)
- [ ] S124: Implement config flag/env default `AI_STRATEGY` with per-game override
- [ ] S125: Alternate first move across games; add config to choose first player
- [ ] S126: Implement client Options Panel toggle (Random/AI) persisted to localStorage; accessible form controls; send in `create_game`
- [ ] S126a: E2E gameplay (HvRandom): alternating first turns, making moves, and result banner behavior
- [ ] S127: Implement offline mode: detect disconnects and switch to local random strategy
- [ ] S128: Show offline banner and disable server emits while offline
- [ ] S129: On reconnect, maintain session; do not replay offline games to server
- [ ] S130: Define MongoDB schemas for games, moves, sessions, models, logs
- [ ] S131: Add compound indexes for `gameId`, `sessionId`, timestamps
- [ ] S132: Add migration tooling (migrate-mongo) and initial baseline migration
- [ ] S133: Implement `saveGameStart(game)` persistence
- [ ] S134: Implement `saveMove(move)` persistence
- [ ] S135: Implement `saveGameOutcome(gameId, result)` persistence
- [ ] S136: Implement Redis key patterns for live game state
- [ ] S137: Implement Redis set/get with TTL for caches
- [ ] S138: Implement retention job to delete old logs
- [ ] S139: Add configuration for retention TTL days
- [ ] S140: Configure server logger transport to MongoDB and sampling
- [ ] S141: Implement client log wrapper and pre-filtering
- [ ] S142: Send batched client logs to server endpoint
- [ ] S143: Implement admin endpoint to change log level (with auth)
- [ ] S144: Propagate new log level to connected clients
- [ ] S145: Implement log export endpoint (CSV/JSON) and streaming query
- [ ] S146: Create Python AI microservice under `server/ai_service`
- [ ] S147: Initialize FastAPI app with `/infer` and `/train` endpoints
- [ ] S148: Define Pydantic schemas aligned with Node types
- [ ] S149: Add `requirements.txt` and uvicorn entrypoint
- [ ] S150: Add Dockerfile for Python service
- [ ] S151: Connect Python service to Redis; choose RQ or Celery for training jobs
- [ ] S152: Implement training worker with quotas and kill switch
- [ ] S153: Implement model registry/versioning with metadata and storage
- [ ] S154: Implement Node inference client calling Python over HTTP with timeout
- [ ] S155: Add circuit breaker and graceful fallback to random on failure (with warn logs)
- [ ] S156: Support seeded deterministic evaluation mode via query/headers
- [ ] S157: Expose move latency metric including Python inference time
- [ ] S158: Add tracing propagation between Node and Python services
- [ ] S159: Implement `calculateEMA(games, N, alpha)` function
- [ ] S160: Use SMA fallback when games < N and annotate
- [ ] S161: Exclude acquiesced sessions from aggregates
- [ ] S162: Apply smoothing thresholds and anomaly clamps
- [ ] S163: Implement `/stats/ema` endpoint with parameters
- [ ] S164: Aggregate EMA, win/draw rates, and latency from DB
- [ ] S165: Build frontend charts consuming stats API
- [ ] S166: Add preset buttons for selectable N values
- [ ] S167: Persist selected N in local storage and restore on load
- [ ] S168: Implement milestone banners based on EMA thresholds
- [ ] S169: Build collapsible insights panel showing thinking time
- [ ] S170: Enforce spectating capacity and emit rejection on overflow
- [ ] S171: Implement private game toggle and lobby filtering
- [ ] S172: Add E2E tests for observer sync and non-interference
- [ ] S173: Enforce HTTPS/WSS for server
- [ ] S174: Implement optional JWT auth and rate limiting
- [ ] S175: Implement abuse detection (spam rooms, rapid reconnects)
- [ ] S176: Load secrets from environment/SSM and rotate keys policy
- [ ] S177: Add input schema validation for all payloads and CSRF for REST
- [ ] S178: Generate SBOM (Syft) in CI and scan images (Trivy)
- [ ] S179: Add secret scanning (Gitleaks) and dependency audits to CI
- [ ] S180: Configure client reconnect/backoff and session resume
- [ ] S181: Wrap emits with retry on transient errors
- [ ] S182: Configure bounded queues and load shedding policy
- [ ] S183: Implement graceful shutdown with in-flight state persistence
- [ ] S184: Introduce chaos tests (kill server, drop sockets) and verify recovery
- [ ] S185: Integration: restart during active room with backoff/port-wait; packet delay/loss injection (on-demand CI)
- [ ] S186: Add ARIA labels/roles to the board and controls
- [ ] S187: Expand theme provider with light/dark modes (rich theming; refined palette/typography/spacing); polish aesthetics
- [ ] S188: Add sound/haptics toggles
- [ ] S189: Implement tutorial/onboarding modal
- [ ] S190: Implement undo/redo stack for casual mode
- [ ] S191: Add contract tests for event schemas and acknowledgements
- [ ] S192: Add cross-browser/device tests (incl. throttled networks)
- [ ] S193: Add E2E tests for H2H, HvAI, spectating, and error paths
- [ ] S194: Add performance/load tests with thresholds (Artillery)
- [ ] S195: Implement unified start script for server, client, or both (bg)
- [ ] S196: Implement single stop script with PID tracking and port cleanup (3001/5173)
- [ ] S197: Ensure scripts kill stray Node/Vite processes before restart
- [ ] S198: Add PM2 ecosystem file for background processes
- [ ] S199: Wire health/readiness probes into PM2 configuration
- [ ] S200: Expand CI workflow with typecheck/tests/E2E/security jobs
- [ ] S201: Create Dockerfiles for server and client
- [ ] S202: Configure image publishing to registry
- [ ] S203: Add IaC (Terraform) for staging/prod (ECS/EKS, Redis, Mongo)
- [ ] S204: Deploy staging environment using CI/CD
- [ ] S205: Configure blue/green or canary deployment and rollback
- [ ] S206: Implement cron retention jobs for logs and sessions
- [ ] S207: Implement nightly Mongo/Redis backups and restore runbook
- [ ] S208: Implement anonymized research export and erasure flow
- [ ] S209: Implement difficulty modes (Beginner/Learning/Advanced)
- [ ] S210: Add per-mode target loss ratio configuration
- [ ] S211: Implement model reset to zero-knowledge per mode
- [ ] S212: Implement self-play job in Python service with iteration cap and quotas
- [ ] S213: Add monitoring for overfitting/drift and scheduled evaluations
- [ ] S214: Document API events and error catalog in `docs/`
- [ ] S215: Write ops runbooks (restart, rollback, incident, DR)
- [ ] S216: Add CONTRIBUTING.md and architecture diagram
- [ ] S217: Housekeeping: update `docs/checklist.md` and `docs/notes.md`

## Release Readiness Checklist
- [ ] S218: SLOs met (latency/availability)
- [ ] S219: Load test ≥100 concurrent connections stable
- [ ] S220: Security review passed; privacy notice present
- [ ] S221: A11y checks passed; core UX complete
- [ ] S222: All tests green; CI/CD proven; backups verified


