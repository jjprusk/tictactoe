# Implementation Plan

Concise, incremental steps to implement the TicTacToe AI system defined in `docs/request.md`. Steps are grouped by milestone; each step is intentionally small and builds on prior work.

## Guiding Principles
- Many small, verifiable steps; ship value early and often
- Backend-only AI; client is UI + real-time sync
- Tests first for core logic; maintain ≥90% coverage
- Observability, security, and reliability baked-in from the start
- Enforce minimum test coverage targets: lines/statements ≥70%, functions ≥70%, branches ≥60%

## Alignment with `docs/project_rules.md`
- Implement unified logger/debugger early (M1) and expand capabilities soon after (M8)
- Introduce asynchronous services (Socket.IO) early (M1–M4) with heavy async testing
- Use very descriptive variable names and write clean, effective code
- Add comments only for complex/critical sections
- Place all code strictly in `client/` or `server/`; all docs in `docs/`
- Provide tests with every milestone; extra coverage for async/networking
- Update `docs/checklist.md` after each approved milestone
- When sharing code in reviews/PRs, include full files (no placeholders)

## Coding Standards (applies to all milestones)
- Descriptive identifiers; avoid abbreviations; prefer clarity over brevity
- Minimal comments; only where logic is non-obvious; explain the “why”
- Consistent formatting (ESLint/Prettier); TypeScript strict mode
- Avoid deep nesting; use guard clauses; meaningful error handling
- Add a file header to all newly created code files containing: "© 2025 Joe Pruskowski"

## Per‑Milestone Housekeeping
- Mark completed steps in this plan after tests pass and approval
- Add brief notes of key decisions to `docs/notes.md`
- Ensure new code lives under `client/` or `server/` only; docs under `docs/`
- Ensure appropriate tests (unit/integration/E2E) are added/updated

-## Flat Implementation Steps (Ordered)
- [x] S001: Create repository structure with `server/`, `client/`, and `docs/` directories
- [x] S002: Add root package.json (or monorepo tooling if chosen)
- [x] S003: Initialize Git repository
- [x] S004: Create `.gitignore` with standard exclusions
- [x] S005: Add `.editorconfig` for consistent formatting
- [x] S006: Add LICENSE file (e.g., MIT)
- [x] S007: Create `README.md` with overview and setup instructions
- [x] S008: Specify Node.js engines (>=20) in package.json
- [x] S009: Choose package manager (npm) and commit lockfile
- [x] S010: Document dependency pinning policy in `README.md`
- [x] S011: Create `docs/notes.md`
- [x] S012: Create `.env.example` listing required environment variables
- [x] S013: Install and configure environment validation (zod)
- [x] S014: Implement environment loader with schema validation
- [x] S015: Create CI workflow file `.github/workflows/ci.yml`
- [x] S016: Add lint and typecheck jobs to CI
- [x] S017: Push dummy commit to verify CI runs
- [x] S018: Add PR template `.github/pull_request_template.md`
- [x] S019: Add `CODEOWNERS` file
- [x] S020: Install and configure commitlint and husky (Conventional Commits)
- [x] S021: Configure branch protections and required status checks on `main`
- [x] S022: Install Socket.IO server library and attach to HTTP server
- [x] S023: Emit a health event on client connect; log connect/disconnect
- [x] S024: Install configuration validation (zod/envsafe) for server
- [x] S025: Define config schema for ports and database URIs
- [x] S026: Load and validate env in server startup; fail fast on invalid
- [x] S027: Install MongoDB driver and implement connection with retry
- [x] S028: Add MongoDB ping check to `/readyz`
- [x] S029: Write unit tests for MongoDB connection handling
- [x] S030: Create `server/package.json`
- [x] S031: Install Express and types in server
- [x] S032: Create `server/src/index.ts`
- [x] S033: Initialize Express app with JSON middleware
- [x] S034: Add basic GET `/` route returning a hello message
- [x] S035: Install and configure logger (pino or winston)
- [x] S036: Add request correlation IDs via middleware
- [x] S037: Output structured logs to console and file
- [x] S038: Add minimal security headers: strict CORS and Content Security Policy
- [x] S039: Implement GET `/healthz` returning `{ status: 'ok' }`
- [x] S040: Implement GET `/readyz` performing readiness checks
- [x] S041: Write unit tests for `/healthz` and `/readyz`
- [x] S042: Install Socket.IO server library and attach to HTTP server
- [x] S043: Emit a health event on client connect; log connect/disconnect
- [x] S044: Install configuration validation (zod/envsafe) for server
- [x] S045: Define config schema for ports and database URIs
- [x] S046: Load and validate env in server startup; fail fast on invalid
- [x] S047: Install MongoDB driver and implement connection with retry
- [x] S048: Add MongoDB ping check to `/readyz`
- [x] S049: Write unit tests for MongoDB connection handling
- [x] S050: Install Redis client (ioredis or redis)
- [x] S051: Implement Redis connection and ping check
- [x] S052: Write unit tests for Redis operations
- [x] S053: Instrument Prometheus metrics (HTTP durations, socket reconnects)
- [x] S054: Add move latency histogram metric on server
- [x] S055: Initialize OpenTelemetry tracing (basic spans on move lifecycle)r
- [ ] S056: Create `scripts/start-server.sh` with port cleanup and start
- [x] S057: Add SIGTERM handler for graceful server shutdown
- [ ] S058: Test server start/stop scripts locally
- [ ] S059: Define Board type (3x3) for game engine
- [ ] S060: Define Player enum (X, O, None)
- [ ] S061: Implement `GameState` interface (board, currentPlayer, moves)
- [ ] S062: Implement `isValidMove(state, position)`
- [ ] S063: Implement `applyMove(state, position, player)`
- [ ] S064: Implement turn alternation logic
- [ ] S065: Implement `checkWin(board, player)` for rows/cols/diagonals
- [ ] S066: Implement `checkDraw(board)` logic
- [ ] S067: Integrate post-move win/draw checks
- [ ] S068: Implement JSON-safe state serialization
- [ ] S069: Define event types `MoveMade` and `GameOver`
- [ ] S070: Write unit tests for valid/invalid moves
- [ ] S071: Write unit tests for all win patterns and draws
- [ ] S072: Add property-based tests for engine invariants
- [ ] S073: Create client app with Vite (React + TypeScript) in `client/`
- [ ] S074: Configure `vite.config.ts` with aliases and base settings
- [ ] S075: Remove template boilerplate from `App.tsx`
- [ ] S076: Install Redux Toolkit and React Redux in client
- [ ] S077: Create `store.ts` and root reducer
- [ ] S078: Add `session` slice with initial state
- [ ] S079: Wrap app with Redux Provider in `index.tsx`
- [ ] S080: Install Socket.IO client library
- [ ] S081: Create client socket service (connect/disconnect handlers)
- [ ] S082: Add connection status indicator component
- [ ] S083: Dispatch Redux actions on socket events
- [ ] S084: Implement responsive layout (header, game area, panel)
- [ ] S085: Create header with title/logo
- [ ] S086: Add placeholders for game board and insights panel
- [ ] S087: Create `scripts/start-client.sh` with port cleanup and start
- [ ] S088: Test client start script locally
- [ ] S089: Define Socket.IO event contracts (`create_game`, `join_game`, `leave_game`, `make_move`, `game_state`, `error`)
- [ ] S090: Implement server event handlers with type-safe payloads
- [ ] S091: Implement client emitters with type-safe payloads
- [ ] S092: Add schema validation for received events
- [ ] S093: Implement room creation with generated `roomId` and host role
- [ ] S094: Implement role assignment on join (player/observer)
- [ ] S095: Track room membership and roles on server
- [ ] S096: Generate client-side nonce per move
- [ ] S097: Deduplicate moves on server by nonce per game
- [ ] S098: Use Socket.IO acknowledgements with timeouts
- [ ] S099: Implement standardized error payloads
- [ ] S100: Configure client reconnect with exponential backoff
- [ ] S101: On reconnect, rejoin room using a session token
- [ ] S102: Implement optimistic UI for moves and server reconciliation
- [ ] S103: Build `Board.tsx` 3x3 grid component
- [ ] S104: Add touch and click handlers for squares
- [ ] S105: Add keyboard navigation with appropriate ARIA roles
- [ ] S106: Implement current player indicator component
- [ ] S107: Highlight last move via CSS
- [ ] S108: Implement result banner (win/draw/loss)
- [ ] S109: Add reset button that emits reset event
- [ ] S110: Make spectator view read-only and label spectators
- [ ] S111: Implement lobby page fetching active games
- [ ] S112: Implement join button emitting `join_game`
- [ ] S113: Define `AIRequest` (gameState, player) and `AIResponse` (position)
- [ ] S114: Implement `getValidMoves(state)` function
- [ ] S115: Implement random-move AI agent
- [ ] S116: Integrate AI into match flow as a virtual player
- [ ] S117: Measure and log AI inference latency
- [ ] S118: Implement config flag to choose first player
- [ ] S119: Alternate first move across games based on count
- [ ] S120: Implement offline mode: detect disconnects and switch to local random AI
- [ ] S121: Show offline banner and disable server emits while offline
- [ ] S122: On reconnect, maintain session; do not replay offline games to server
- [ ] S123: Define MongoDB schemas for games, moves, sessions, models, logs
- [ ] S124: Add compound indexes for `gameId`, `sessionId`, timestamps
- [ ] S125: Add migration tooling (migrate-mongo) and initial baseline migration
- [ ] S126: Implement `saveGameStart(game)` persistence
- [ ] S127: Implement `saveMove(move)` persistence
- [ ] S128: Implement `saveGameOutcome(gameId, result)` persistence
- [ ] S129: Implement Redis key patterns for live game state
- [ ] S130: Implement Redis set/get with TTL for caches
- [ ] S131: Implement retention job to delete old logs
- [ ] S132: Add configuration for retention TTL days
- [ ] S133: Configure server logger transport to MongoDB and sampling
- [ ] S134: Implement client log wrapper and pre-filtering
- [ ] S135: Send batched client logs to server endpoint
- [ ] S136: Implement admin endpoint to change log level (with auth)
- [ ] S137: Propagate new log level to connected clients
- [ ] S138: Implement log export endpoint (CSV/JSON)
- [ ] S139: Query logs from MongoDB and stream export
- [ ] S140: Create Python AI microservice under `server/ai_service`
- [ ] S141: Initialize FastAPI app with `/infer` and `/train` endpoints
- [ ] S142: Define Pydantic schemas aligned with Node types
- [ ] S143: Add `requirements.txt` and uvicorn entrypoint
- [ ] S144: Add Dockerfile for Python service
- [ ] S145: Connect Python service to Redis; choose RQ or Celery for training jobs
- [ ] S146: Implement training worker with quotas and kill switch
- [ ] S147: Implement model registry/versioning with metadata and storage
- [ ] S148: In Node, implement inference client calling Python over HTTP with timeout
- [ ] S149: Add circuit breaker and fallback to random agent on failure
- [ ] S150: Support seeded deterministic evaluation mode via query/headers
- [ ] S151: Expose move latency metric including Python inference time
- [ ] S152: Add tracing propagation between Node and Python services
- [ ] S153: Implement `calculateEMA(games, N, alpha)` function
- [ ] S154: Use SMA fallback when games < N and annotate
- [ ] S155: Exclude acquiesced sessions from aggregates
- [ ] S156: Apply smoothing thresholds and anomaly clamps
- [ ] S157: Implement `/stats/ema` endpoint with parameters
- [ ] S158: Aggregate EMA, win/draw rates, and latency from DB
- [ ] S159: Build frontend charts consuming stats API
- [ ] S160: Add preset buttons for selectable N values
- [ ] S161: Persist selected N in local storage and restore on load
- [ ] S162: Implement milestone banners based on EMA thresholds
- [ ] S163: Build collapsible insights panel showing thinking time
- [ ] S164: Enforce spectating capacity and emit rejection on overflow
- [ ] S165: Implement private game toggle and lobby filtering
- [ ] S166: Add E2E tests for observer sync and non-interference
- [ ] S167: Enforce HTTPS/WSS for server
- [ ] S168: Implement optional JWT auth and rate limiting
- [ ] S169: Implement abuse detection (spam rooms, rapid reconnects)
- [ ] S170: Load secrets from environment/SSM and rotate keys policy
- [ ] S171: Add input schema validation for all payloads and CSRF for REST
- [ ] S172: Generate SBOM (Syft) in CI and scan images (Trivy)
- [ ] S173: Add secret scanning (Gitleaks) and dependency audits to CI
- [ ] S174: Configure client reconnect/backoff and session resume
- [ ] S175: Wrap emits with retry on transient errors
- [ ] S176: Configure bounded queues and load shedding policy
- [ ] S177: Implement graceful shutdown with in-flight state persistence
- [ ] S178: Introduce chaos tests (kill server, drop sockets) and verify recovery
- [ ] S178a: Integration: restart during active room with backoff/port-wait; packet delay/loss injection (on-demand CI)
- [ ] S179: Add ARIA labels/roles to the board and controls
- [ ] S180: Implement theme provider with light/dark modes
- [ ] S181: Add sound/haptics toggles
- [ ] S182: Implement tutorial/onboarding modal
- [ ] S183: Implement undo/redo stack for casual mode
- [ ] S184: Add contract tests for event schemas and acknowledgements
- [ ] S185: Add cross-browser/device tests (incl. throttled networks)
- [ ] S186: Add E2E tests for H2H, HvAI, spectating, and error paths
- [ ] S187: Add performance/load tests with thresholds (Artillery)
- [ ] S188: Implement unified start script for server, client, or both (bg)
- [ ] S189: Implement single stop script with PID tracking and port cleanup (3001/5173)
- [ ] S190: Ensure scripts kill stray Node/Vite processes before restart
- [ ] S191: Add PM2 ecosystem file for background processes
- [ ] S192: Wire health/readiness probes into PM2 configuration
- [ ] S193: Expand CI workflow with typecheck/tests/E2E/security jobs
- [ ] S194: Create Dockerfiles for server and client
- [ ] S195: Configure image publishing to registry
- [ ] S196: Add IaC (Terraform) for staging/prod (ECS/EKS, Redis, Mongo)
- [ ] S197: Deploy staging environment using CI/CD
- [ ] S198: Configure blue/green or canary deployment and rollback
- [ ] S199: Implement cron retention jobs for logs and sessions
- [ ] S200: Implement nightly Mongo/Redis backups and restore runbook
- [ ] S201: Implement anonymized research export and erasure flow
- [ ] S202: Implement difficulty modes (Beginner/Learning/Advanced)
- [ ] S203: Add per-mode target loss ratio configuration
- [ ] S204: Implement model reset to zero-knowledge per mode
- [ ] S205: Implement self-play job in Python service with iteration cap and quotas
- [ ] S206: Add monitoring for overfitting/drift and scheduled evaluations
- [ ] S207: Document API events and error catalog in `docs/`
- [ ] S208: Write ops runbooks (restart, rollback, incident, DR)
- [ ] S209: Add CONTRIBUTING.md and architecture diagram
- [ ] S210: Housekeeping: update `docs/checklist.md` and `docs/notes.md`

## Release Readiness Checklist
- [ ] S211: SLOs met (latency/availability)
- [ ] S212: Load test ≥100 concurrent connections stable
- [ ] S213: Security review passed; privacy notice present
- [ ] S214: A11y checks passed; core UX complete
- [ ] S215: All tests green; CI/CD proven; backups verified


